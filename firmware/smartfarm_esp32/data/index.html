<!doctype html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SmartFarm</title>
    <style>
        body{font-family:system-ui,Arial;margin:16px;max-width:760px}
        .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
        .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
        .kv{background:#fafafa;border-radius:10px;padding:12px;text-align:center}
        button{padding:10px 14px;border-radius:10px;border:1px solid #333;background:#fff;cursor:pointer}
        button.on{background:#16a34a;color:#fff;border-color:#16a34a}
        .small{color:#666;font-size:12px}
        @media (max-width:560px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    </style>
    </head>
    <body>
    <h1>üå± SmartFarm</h1>

    <div class="card">
    <div class="grid">
        <div class="kv"><b>Temp</b><div id="temp">--</div></div>
        <div class="kv"><b>Hum</b><div id="hum">--</div></div>
        <div class="kv"><b>Soil %</b><div id="soil">--</div></div>
        <div class="kv"><b>Soil RAW</b><div id="soilraw">--</div></div>
        <div class="kv"><b>Soil State</b><div id="soilstate">--</div></div>
    </div>

    <div style="margin-top:12px">
        <button id="fanBtn" onclick="toggle('fan')">Fan</button>
    </div>
    <div id="ts" class="small"></div>
    <h3>Notes & Thresholds</h3>
    <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;max-width:760px">
        <div class="kv">
        <b>DRY</b>
        <div id="dryRange">soil % &lt; 40.0</div>
        </div>
        <div class="kv">
        <b>OK</b>
        <div id="okRange">40.0 ‚Äì 69.9</div>
        </div>
        <div class="kv">
        <b>WET</b>
        <div id="wetRange">‚â• 70.0</div>
        </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <label>OK min % <input id="okLow" type="number" step="0.1" value="40.0" style="width:90px"></label>
        <label>WET min % <input id="wetLow" type="number" step="0.1" value="70.0" style="width:90px"></label>
        <button id="saveCfgBtn">Save</button>
    </div>

    <div style="margin-top:12px">
        <textarea id="note" rows="4" style="width:100%;box-sizing:border-box" placeholder="Î©îÎ™®Î•º Ï†ÅÏñ¥ÎëêÏÑ∏Ïöî (Ïòà: Ïò§Îäò Í∏âÏàò Ïã§Ìóò, ÏÑºÏÑú ÍµêÏ≤¥ Îì±)"></textarea>
    </div>
    <div class="small" id="cfgTs"></div>

    </div>

    <script>
    const $ = id => document.getElementById(id);

    function setBtn(el,on){
    el.classList.toggle('on', on);
    el.textContent = on ? 'Fan (ON)' : 'Fan';
    }

    async function refresh(){
    try{
        const r = await fetch('/status');
        const j = await r.json();

        // Î™®Îëê ÏÜåÏàò Ìè¨Ìï®Ìï¥ÏÑú ÌëúÍ∏∞
        if (j.temp > -999)  $('temp').textContent = j.temp.toFixed(1) + ' \u00B0C';
        else                $('temp').textContent = '--';

        if (j.hum > -999)   $('hum').textContent  = j.hum.toFixed(1) + ' %';
        else                $('hum').textContent  = '--';

        if ('soil_pct' in j) $('soil').textContent = j.soil_pct.toFixed(1) + ' %';
        if ('soil_raw' in j) $('soilraw').textContent = j.soil_raw;
        if ('soil_state' in j) $('soilstate').textContent = j.soil_state;

        $('ts').textContent = 'Updated ' + new Date().toLocaleTimeString();
    }catch(e){
        console.log(e);
    }
    }

    async function toggle(which){
    const el = $('fanBtn');
    const on = !el.classList.contains('on');
    await fetch('/act?'+which+'='+(on?1:0));
    setBtn(el,on);
    }

    setInterval(refresh, 2000);
    refresh();
    async function loadCfg(){
    try{
        const r = await fetch('/cfg');
        if(!r.ok) return;
        const c = await r.json();
        $('okLow').value  = c.ok_low.toFixed(1);
        $('wetLow').value = c.wet_low.toFixed(1);
        $('note').value   = c.note || '';
        renderRanges();
        $('cfgTs').textContent = 'Config loaded';
    }catch(e){ console.log(e); }
    }
    function renderRanges(){
    const okL  = parseFloat($('okLow').value);
    const wetL = parseFloat($('wetLow').value);
    $('dryRange').textContent = `soil % < ${okL.toFixed(1)}`;
    $('okRange').textContent  = `${okL.toFixed(1)} ‚Äì ${(wetL-0.1).toFixed(1)}`;
    $('wetRange').textContent = `‚â• ${wetL.toFixed(1)}`;
    }

    $('okLow').addEventListener('input', renderRanges);
    $('wetLow').addEventListener('input', renderRanges);
    $('saveCfgBtn').addEventListener('click', async ()=>{
    const body = new URLSearchParams({
        ok_low: $('okLow').value,
        wet_low: $('wetLow').value,
        note: $('note').value
    });
    const r = await fetch('/cfg', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
    $('cfgTs').textContent = r.ok ? 'Saved!' : 'Save failed';
    });

    // ÌéòÏù¥ÏßÄ ÏßÑÏûÖ Ïãú ÏÑ§Ï†ï/ÎÖ∏Ìä∏ Î°úÎìú
    loadCfg();
    </script>
    </body>

</html>
